{% extends "layout.html" %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>


{% block title %}Portfolio Simulation{% endblock %}

{% block main %}
    <!--<h1>Portfolio Monte Carlo Simulation</h1>-->

    <!-- Form with preserved inputs -->
    <div style="display: flex; flex-direction: column;">
        <form id="compare" method="POST" style="width: 100%; text-align: left;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem;">
                {% for field in ['Monthly', 'SYear', 'FYear', 'NSimulations', 'future'] %}
                <div style="flex: 1;">
                    <input autocomplete="off" class="form-control" 
                           name="{{ field }}" 
                           placeholder="{{ {
                               'Monthly': 'Monthly Investments ($)',
                               'SYear': 'Starting Year',
                               'FYear': 'Final Year',
                               'NSimulations': 'Simulation Count',
                               'future': 'Years to Project'
                           }[field] }}"
                           type="number"
                           value="{{ form_data[field] if form_data else '' }}">
                </div>
                {% endfor %}
            </div>
            <div style="display: flex; justify-content: center;">
                <button class="btn btn-primary" type="submit">Calculate</button>
            </div>
        </form>
    </div>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if plots %}
        <!-- Results Section -->


        <div class="mt-5">            
            <!-- Container principal com flexbox -->
            <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between;">
                <!-- Primeira linha - 2 gráficos -->
                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 40px;">
                    <canvas id="sp500"></canvas>
                </div>
                
                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 40px;">
                    <canvas id="lineplot"></canvas>
                    <h5>y = {{coef_0}}x + {{coef_1}}</h5>
                </div>
                
                <!-- Segunda linha - 2 gráficos -->
                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 40px;">
                    <canvas id="sp_vs_exp"></canvas>
                    <h5>Compound Annual Growth Rate(CAGR) = {{cagr}}%</h5>

                </div>
                
                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 80px;">
                    <canvas id="diference"></canvas>
                </div>

                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 80px;">
                    <canvas id="standart_vs_weigted"></canvas>
                    <h5>Buy and Hold Value = {{s_port_final}} $</h5>
                    <h5>Weighted Investment Value = {{s_port_final2}} $</h5>
                    <h5>Relative Diference = {{rel_dif_inv}} %</h5>
                </div>

                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 80px;">
                    <canvas id="standart_vs_weigted_alloc"></canvas>
                    <h5>Buy and Hold Alloc = {{s_allocated}} $</h5>
                    <h5>Weighted Investment Alloc = {{s_allocated2}} $</h5>
                    <h5>Relative Diference = {{rel_dif_alloc}} %</h5>
                </div>
                
                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 40px;">
                    <canvas id="standart_vs_weigted_diff"></canvas>
                </div>

                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 40px;">
                    <canvas style="height: 100%; width: 100%;" id="montecarlo"></canvas>
                    <h5>{{monte_carlo_over_under_valuation_str}}%</h5>
                </div>

                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 40px;">
                    <canvas style="height: 100%; width: 100%;" id="histogram_final_values"></canvas>
                    <h5>Average Buy and Hold = {{media_std}} $</h5>
                    <h5>Average Weighted Investment = {{media_maltez}} $</h5>
                </div>

                <div style="flex: 1 1 24%; min-width: 300px; height: 400px; margin-bottom: 20px;">
                    <canvas style="height: 100%; width: 100%;" id="histogram_roi"></canvas>
                    <h5>Average ROI Buy and Hold = {{media_roi_std}}%</h5>
                    <h5>Average ROI Weighted Investment = {{media_roi_maltez}}%</h5>

                </div>
            </div>
        </div>

        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('sp500').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ timeline | tojson }},
                            datasets: [
                                {
                                    label: 'S&P 500 Data Prices',
                                    data: {{ sp500_prices | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    }
                );
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('lineplot').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ timeline | tojson }},
                            datasets: [
                                {
                                    label: 'LOG S&P 500 Data Prices',
                                    data: {{ log_sp500 | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {% if av_log %}
                                {
                                    label: 'Linear Regression',
                                    data: {{ av_log | tojson }},
                                    borderColor: 'rgba(192, 75, 192, 1)',
                                    backgroundColor: 'rgba(192, 75, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                                {% endif %}
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    }
                );
                
                // Add more chart initializations as needed
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('sp_vs_exp').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ timeline | tojson }},
                            datasets: [
                                {
                                    label: 'S&P 500 Data Prices',
                                    data: {{ exp_sp | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {% if av_log %}
                                {
                                    label: 'Average exponential S&P 500',
                                    data: {{ av_exp | tojson }},
                                    borderColor: 'rgba(192, 75, 192, 1)',
                                    backgroundColor: 'rgba(192, 75, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                                {% endif %}
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    }
                );
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('diference').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ timeline | tojson }},
                            datasets: [
                                {
                                    label: 'Relative Diference Between Average and Real',
                                    data: {{ diference | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    }
                );
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('standart_vs_weigted').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ timeline | tojson }},
                            datasets: [
                                {
                                    label: 'Buy and Hold',
                                    data: {{ s_portfolio | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {% if s_portfolio2 %}
                                {
                                    label: 'Weighted Investment',
                                    data: {{ s_portfolio2 | tojson }},
                                    borderColor: 'rgba(192, 75, 192, 1)',
                                    backgroundColor: 'rgba(192, 75, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                                {% endif %}
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    }
                );
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('standart_vs_weigted_alloc').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ timeline | tojson }},
                            datasets: [
                                {
                                    label: 'Buy and Hold',
                                    data: {{ s_total_invest | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {% if s_total_allocation %}
                                {
                                    label: 'Weighted Investment',
                                    data: {{ s_total_allocation | tojson }},
                                    borderColor: 'rgba(192, 75, 192, 1)',
                                    backgroundColor: 'rgba(192, 75, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                                {% endif %}
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    }
                );
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('standart_vs_weigted_diff').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ timeline | tojson }},
                            datasets: [
                                {
                                    label: 'Diference Between (Weighted) and (Buy and Hold)',
                                    data: {{ dif | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    }
                );
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Line Chart
                new Chart(
                    document.getElementById('montecarlo').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: {{ future_dates | tojson }},  // Datas no eixo X
                            datasets: [
                                {
                                    label: 'Average S&P 500 prediction',
                                    data: {{ y_pred_future | tojson }},
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                //{
                                //   label: 'Media',
                                //    data: {{ mean_values | tojson }},
                                //    borderColor: 'rgba(75, 192, 192, 1)',  // Verde
                                //    borderWidth: 2,
                                //    pointRadius: 0
                                //},
                                {
                                    label: 'Max',
                                    data: {{ max_values | tojson }},
                                    borderColor: 'rgba(255, 99, 132, 0.8)',  // Vermelho
                                    borderWidth: 1,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    pointRadius: 0,  // Sem pontos para melhor performance
                                    fill: false
                                },
                                {
                                    label: 'Min',
                                    data: {{ min_values | tojson }},
                                    borderColor: 'rgba(54, 162, 235, 0.8)',  // Azul
                                    borderWidth: 1,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    pointRadius: 0,
                                    fill: '-1'  // Preenche a área entre este e o dataset anterior
                                },
                                
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Faixa de Resultados (Monte Carlo)'
                                }
                            },
                            scales: {
                                y: { beginAtZero: false }
                            }
                        }
                    }
                );
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
            // Dados passados do Flask (substitua pelos seus dados reais)
            const f1 = {{ final_values1 | tojson }};  // Array de valores do Buy and Hold
            const f2 = {{ final_values2 | tojson }};  // Array de valores do Weighted Investment

            // Configuração dos bins (igual ao Python)
            const binWidth = {{ bin_width2 | tojson }};
            const minVal = {{ bin_min_value | tojson }};
            const maxVal = {{ bin_max_value | tojson }};
            const bins = {{ bins2 | tojson }};

            // Calcula as frequências para cada dataset
            const countInBin = (data, bins) => {
                const counts = new Array(bins.length - 1).fill(0);
                data.forEach(value => {
                    const index = bins.findIndex(bin => value <= bin) - 1;
                    if (index >= 0 && index < counts.length) counts[index]++;
                });
                return counts;
            };

            const f1Counts = countInBin(f1, bins);
            const f2Counts = countInBin(f2, bins);

            // Médias
            const f1Mean = f1.reduce((a, b) => a + b, 0) / f1.length;
            const f2Mean = f2.reduce((a, b) => a + b, 0) / f2.length;

            // Criação do gráfico
            const ctx = document.getElementById('histogram_final_values').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.slice(0, -1).map((bin, i) => `${bin.toFixed(0)}-${bins[i+1].toFixed(0)}`),
                    datasets: [
                        {
                            label: 'Buy and Hold',
                            data: f1Counts,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 0.6)',          
                            borderWidth: 1,
                        },
                        {
                            label: 'Weighted Investment',
                            data: f2Counts,
                            backgroundColor: 'rgba(192, 75, 192, 0.7)',    // vermelho com transparência
                            borderColor: 'rgba(192, 75, 192, 0.7)',
                            borderWidth: 1
                        }
                    ]
                },
            });
        });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
            // Dados passados do Flask (substitua pelos seus dados reais)
            const f1 = {{ roi_standart | tojson }};  // Array de valores do Buy and Hold
            const f2 = {{ roi_maltez | tojson }};  // Array de valores do Weighted Investment

            // Configuração dos bins (igual ao Python)
            const binWidth = {{ bin_width | tojson }};
            const minVal = {{ bin_min_value | tojson }};
            const maxVal = {{ bin_max_value | tojson }};
            const bins = {{ bins | tojson }};

            // Calcula as frequências para cada dataset
            const countInBin = (data, bins) => {
                const counts = new Array(bins.length - 1).fill(0);
                data.forEach(value => {
                    const index = bins.findIndex(bin => value <= bin) - 1;
                    if (index >= 0 && index < counts.length) counts[index]++;
                });
                return counts;
            };

            const f1Counts = countInBin(f1, bins);
            const f2Counts = countInBin(f2, bins);

            // Médias
            const f1Mean = f1.reduce((a, b) => a + b, 0) / f1.length;
            const f2Mean = f2.reduce((a, b) => a + b, 0) / f2.length;

            // Criação do gráfico
            const ctx = document.getElementById('histogram_roi').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.slice(0, -1).map((bin, i) => `${bin.toFixed(0)}-${bins[i+1].toFixed(0)}`),
                    datasets: [
                        {
                            label: 'Buy and Hold',
                            data: f1Counts,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 0.6)',          
                            borderWidth: 1,
                        },
                        {
                            label: 'Weighted Investment',
                            data: f2Counts,
                            backgroundColor: 'rgba(192, 75, 192, 0.7)',    // vermelho com transparência
                            borderColor: 'rgba(192, 75, 192, 0.7)',
                            borderWidth: 1
                        }
                    ]
                },
            });
        });
        </script>

    
    {% endif %}
{% endblock %}